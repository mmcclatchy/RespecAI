version: '3.8'

services:
  mcp-server:
    build:
      context: .
      dockerfile: Dockerfile.dev
    image: respec-ai-dev:latest
    container_name: respec-ai-mcp-dev
    volumes:
      # Mount source code for live reloading
      - ./src:/app/src:ro
      - ./tests:/app/tests:ro
    networks:
      - respec-dev-network
    environment:
      - STATE_MANAGER=database
      - DATABASE_URL=postgresql://respec:respec_dev@db:5432/respec_dev
      - MCP_LOG_LEVEL=DEBUG
      - MCP_DEBUG=true
    depends_on:
      db:
        condition: service_healthy
    # Port 9876 can be exposed for debugging if needed
    # ports:
    #   - "9876:9876"
    # Container uses tail -f /dev/null from Dockerfile
    # MCP server started via docker exec when needed
    stdin_open: true
    tty: true

  db:
    image: postgres:16-alpine
    container_name: respec-ai-db-dev
    environment:
      - POSTGRES_DB=respec_dev
      - POSTGRES_USER=respec
      - POSTGRES_PASSWORD=respec_dev
    networks:
      - respec-dev-network
    volumes:
      - respec_ai_dev_data:/var/lib/postgresql/data
      - ./migrations:/docker-entrypoint-initdb.d:ro
    ports:
      - "5433:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U respec -d respec_dev"]
      interval: 5s
      timeout: 5s
      retries: 5

networks:
  respec-dev-network:
    driver: bridge

volumes:
  respec_ai_dev_data:
    driver: local

# Future: Add migrations service
# migrations:
#   image: migrate/migrate
#   volumes:
#     - ./migrations:/migrations
#   command: ["-path", "/migrations", "-database", "postgresql://respec:respec@db:5432/respec_dev?sslmode=disable", "up"]
